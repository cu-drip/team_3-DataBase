# Flyway — зачем он нужен и как его использовать

## Что такое Flyway

**Flyway** — это лёгкий инструмент для управления версионными миграциями базы данных. Он помогает поддерживать структуру (DDL) и первоначальные данные (DML) в синхронизированном состоянии на всех окружениях:

- локальные машины разработчиков;
- тестовые/CI‐собранные контейнеры;
- staging/production кластеры.

### Главные задачи

| Зачем нужен | Коротко |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Версионирует DDL/DML** | Хранит каждое изменение схемы в отдельном файле, а применённые версии фиксирует в таблице flyway_schema_history. |
| **Автоматика «в один клик»** | Запускаешь flyway migrate → накатываются только те скрипты, которых ещё нет в истории. |
| **Отслеживание истории** | Видно, кто и когда внёс изменение и на каком окружении она применена. |
| **Откат (undo) (Pro)** | В платных редакциях умеет выполнять обратные миграции. |

## Как Flyway работает

1. **Порядок файлов** *Все* SQL‑файлы кладутся в папку migration/ и называют форматом:

   V<номер>__<краткое_описание>.sql

   Пример:

   V1__init_schema.sql     -- создали таблицы User, Team…
   V2__add_payments_table.sql
   V3__add_index_to_payments.sql

   Номер может быть целым (V2), многокомпонентным (V2.1) или датой (V2025.07.03.1500).

2. **Запуск** При старте Flyway:

   - проверяет, есть ли таблица flyway_schema_history;
   - читает из неё уже применённые версии;
   - сортирует файлы по номеру и поднимает только недостающие;
   - каждую успешную миграцию пишет в flyway_schema_history.

3. **Идём в git** Разработчик добавляет новый файл V4__rename_column.sql, коммитит и пушит. CI‑сборка (или docker‑job у нас в infra/flyway/) на новом окружении просто снова делает flyway migrate.

---

## Таблица flyway_schema_history

Flyway автоматически создаёт служебную таблицу **flyway_schema_history** в той же схеме, где выполняются миграции. В ней фиксируется вся история изменений.

| Колонка | Назначение |
| --- | --- |
| **installed_rank** | Порядковый номер применения скрипта |
| **version** | Строковая версия из имени файла\|null для repeatable |
| **description** | Описание после двойного подчёркивания |
| **type** | Тип миграции (SQL, JDBC, repeatable…) |
| **script** | Имя файла миграции |
| **checksum** | CRC‑32 контрольная сумма содержимого |
| **installed_by** | Пользователь БД, выполнивший миграцию |
| **installed_on** | Таймстамп выполнения |
| **execution_time** | Время в миллисекундах |
| **success** | Флаг успешного применения (true/false) |

Эта таблица нужна Flyway, чтобы понимать, какие версии уже установлены, а какие ещё предстоит выполнить. Менять записи руками следует только через команду `flyway repair` — прямое редактирование приведёт к рассинхрону.

## Что ещё умеет Flyway

- **validate** — проверяет, что локальные скрипты совпадают с теми, что в истории (версия, checksum), и что нет пропусков.
- **info** — выводит сводную таблицу всех миграций и их состояние.
- **baseline** — помечает текущую схему как «отправную»; полезно, когда подключаете Flyway к уже существующей базе.
- **repair** — пересчитывает checksum, правит битые записи в flyway_schema_history и помечает провальные миграции как исправленные.
- **clean** *(осторожно!)* — удаляет все объекты схемы; удобно в тестах, но на production применять только если точно понимаете последствия.
- **repeatable (R__) миграции** — файлы формата `R__*.sql`, которые выполняются каждый раз, когда меняется их содержимое.
- **Java‑/Kotlin‑based миграции** — программно описанные изменения, когда SQL недостаточно.
- **Callback‑скрипты** — хуки до/после migrate, validate и других операций.
- **Placeholders** — параметризованные значения (`${schemaName}`) подставляются через конфигурацию или переменные окружения.
- **Dry‑run** (Pro) — генерация итогового SQL без выполнения, чтобы убедиться, что всё корректно.
- **Undo** (Pro) — автоматический откат миграций по файлам `U<VERSION>__*.sql`.


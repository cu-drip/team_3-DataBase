# Flyway — зачем он нужен и как его использовать

## Что такое Flyway

**Flyway** — это лёгкий инструмент для управления версионными миграциями базы данных. Он помогает поддерживать структуру (DDL) и первоначальные данные (DML) в синхронизированном состоянии на всех окружениях:

- локальные машины разработчиков;
- тестовые/CI‐собранные контейнеры;
- staging/production кластеры.

### Главные задачи

| Зачем нужен                  | Коротко                                                                                                            |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Версионирует DDL/DML**     | Хранит каждое изменение схемы в отдельном файле, а применённые версии фиксирует в таблице `flyway_schema_history`. |
| **Автоматика «в один клик»** | Запускаешь `flyway migrate` → накатываются только те скрипты, которых ещё нет в истории.                           |
| **Отслеживание истории**     | Видно, кто и когда внёс изменение и на каком окружении она применена.                                              |
| **Откат (undo) (Pro)**       | В платных редакциях умеет выполнять обратные миграции.                                                             |

## Как Flyway работает

1. **Порядок файлов** *Все* SQL‑файлы кладутся в папку `migration/` и называют форматом:

   ```
   V<номер>__<краткое_описание>.sql
   ```

   Пример:

   ```
   V1__init_schema.sql     -- создали таблицы User, Team…
   V2__add_payments_table.sql
   V3__add_index_to_payments.sql
   ```

   Номер может быть целым (`V2`), многокомпонентным (`V2.1`) или датой (`V2025.07.03.1500`).

2. **Запуск** При старте Flyway:

   - проверяет, есть ли таблица `flyway_schema_history`;
   - читает из неё уже применённые версии;
   - сортирует файлы по номеру и поднимает только недостающие;
   - каждую успешную миграцию пишет в `flyway_schema_history`.

3. **Идём в git** Разработчик добавляет новый файл `V4__rename_column.sql`, коммитит и пушит. CI‑сборка (или docker‑job у нас в `infra/flyway/`) на новом окружении просто снова делает `flyway migrate`.
